<html>
    <head>
        <title>demo</title>
    </head>
    <div id="bar_min_height" style="width: 400px;height: 300px;"></div>
    <div id="pie_min_percent_label" style="width: 400px;height: 300px;"></div>
    <script src="https://cdn.bootcss.com/echarts/3.7.2/echarts.js"></script>
    <script src="echart-soap.js"></script>
    <script>
        option = {
            color: ['#3398DB'],
            tooltip: {
                trigger: 'axis',
                axisPointer: { // 坐标轴指示器，坐标轴触发有效
                    type: 'shadow' // 默认为直线，可选为：'line' | 'shadow'
                }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: [{
                type: 'category',
                data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                axisTick: {
                    alignWithLabel: true
                }
            }],
            yAxis: [{
                type: 'value'
            }],
            series: [{
                name: '直接访问',
                type: 'bar',
                barWidth: '60%',
                data: [10, 52, 200, 334, 390, 330, 220]
            }]
        };

        function safeNestedObjectInspection(obj, path, value) {
            //arr title.textStyle.color
            var arr = path.split("."),
                len = arr.length,
                last = len - 1;
            if (len == 1 && (typeof value == "string" || typeof value == "number")) {
                var key = arr[0];
                obj[key] = value;
            } else {
                var currPath = [],
                    curr;
                for (var index = 0; index < len; index++) {
                    var key = arr[index];
                    currPath.push("['" + key + "']");
                    curr = obj[key];

                    if (index < last) {
                        if (typeof curr === "undefined") {
                            // curr = {};
                            // with(obj){

                            eval("obj" + currPath.join("") + "={};");
                            // }
                        }
                    } else {
                        // with(obj){
                        if (typeof value == "string") {
                            eval("obj" + currPath.join("") + "='" + value + "';");
                        } else {
                            eval("obj" + currPath.join("") + "=" + value + ";");
                        }

                        // }
                    }


                }

            }

            // console.log("safeNestedObjectInspection obj:", obj);
        }
        echarts.registerPreprocessor(function(option) {
            console.log("registerPreprocessor", arguments);
            echarts.util.each(option.series, function(series) {
                switch (series.type) {
                    case "bar":
                        series.barMinHeight = 10
                        break;
                    case "pie":
                        console.log(series.label.normal.position)
                        if (series.label.normal.position = "inner" || series.label.normal.position == "inside") {
                            // series.label.normal.show = false;
                            amount = echarts.util.reduce(series.data, function(sum, item) {
                                return sum + item.value;
                            }, 0)
                            console.log(amount)
                            echarts.util.each(series.data, function(item) {
                                console.log(percent = item.value / amount)
                                safeNestedObjectInspection(item, "label.normal.show", item.value / amount > parseFloat("3.5%") / 100);
                            });
                            console.log("pie", series)
                        }

                        break;

                }
            })
        });
        echarts.registerPostUpdate(function(model, api) {
            console.log("registerPostUpdate", model, api);
            var mergeOption = {
                series: []
            }
            for (var i = model.option.series.length - 1; i >= 0; i--) {

                var series = model.option.series[i],
                    seriesData = series.data;
                var mergeData = {
                    data: []
                }
                switch (series.type) {
                    case "bar":
                        series.barMinHeight = 10
                        break;
                    case "pie":
                        // series.label.normal.position = "inner";


                        for (var j = seriesData.length - 1; j >= 0; j--) {
                            // console.log(model._componentsMap._ec_series[i].getDataParams(j).percent);
                            if (model._componentsMap._ec_series[i].getDataParams(j).percent < 4) {
                                // mergeData
                                // seriesData[j].label.normal.show = false;
                                safeNestedObjectInspection(seriesData[j], "label.normal.show", false);
                                safeNestedObjectInspection(seriesData[j], "label.normal.show", "black")
                                mergeData.data.push(echarts.util.extend({

                                    label: {
                                        normal: {
                                            show: false
                                        }
                                    }

                                }), series.data[j])
                            } else {
                                mergeData.data.push(echarts.util.extend({}, series.data[j], true));
                            }

                        }

                        // model._componentsMap._ec_series[i].mergeOption(series,mergeData);
                        break;

                }
                mergeOption.series.push(echarts.util.extend(mergeData, series, true))

            }
            model.setOption(mergeOption)
            console.log(api.getZr())

            setTimeout(function() {
                    var ins = echarts.getInstanceByDom(api.getZr().dom);
                    // ins.resize();
                    // ins.setOption(mergeOption)
                }, 0)
                // ins.resize();
                // ins.setOption(mergeOption)
                // echarts.util.each( model.option.series,function(series){
                //     console.log("registerPostUpdate each series",series.type,series);
                //        switch(series.type){
                //         case "bar":
                //         series.barMinHeight = 10
                //         break;
                //         case "pie":
                //         series.label.normal.position = "inner";
                //         console.log(model._componentsMap._ec_series[0].getDataParams(0).percent)
                //         for (var k in model._componentsMap._ec_series[0]){
                //             console.log(k)
                //         }

            //         echarts.util.each(model._componentsMap._ec_series[0].ec_dataBeforeProcessed.indices,function(i){
            //             var params = model._componentsMap._ec_series[0].getDataParams(i);
            //             console.log(params);
            //         })
            //         model._componentsMap._ec_series[0].ec_data._itemLayouts //each .angle

            //         console.log("pie",series)
            //         break;

            //     }
            // })

        });

        echartsSoap.render("bar_min_height", option);

        var data = genData(50);
        console.log(data)
        data.seriesData = data.seriesData.concat([{
            value: 335,
            name: '直接访问'
        }, {
            value: 310,
            name: '邮件营销'
        }, {
            value: 234,
            name: '联盟广告'
        }, {
            value: 135,
            name: '视频广告'
        }, {
            value: 1548,
            name: '搜索引擎'
        }])

        option2 = {
            tooltip: {
                trigger: 'item',
                formatter: "{a} <br/>{b}: {c} ({d}%)"
            },
            legend: {
                orient: 'vertical',
                x: 'left',
                data: ['直接访问', '邮件营销', '联盟广告', '视频广告', '搜索引擎']
            },
            series: [{
                name: '访问来源',
                type: 'pie',
                radius: ['50%', '70%'],

                label: {
                    normal: {

                        position: 'center'
                    }
                },

                data: data.seriesData
            }]
        };

        function genData(count) {
            var nameList = [
                '赵', '钱', '孙', '李', '周', '吴', '郑', '王', '冯', '陈', '褚', '卫', '蒋', '沈', '韩', '杨', '朱', '秦', '尤', '许', '何', '吕', '施', '张', '孔', '曹', '严', '华', '金', '魏', '陶', '姜', '戚', '谢', '邹', '喻', '柏', '水', '窦', '章', '云', '苏', '潘', '葛', '奚', '范', '彭', '郎', '鲁', '韦', '昌', '马', '苗', '凤', '花', '方', '俞', '任', '袁', '柳', '酆', '鲍', '史', '唐', '费', '廉', '岑', '薛', '雷', '贺', '倪', '汤', '滕', '殷', '罗', '毕', '郝', '邬', '安', '常', '乐', '于', '时', '傅', '皮', '卞', '齐', '康', '伍', '余', '元', '卜', '顾', '孟', '平', '黄', '和', '穆', '萧', '尹', '姚', '邵', '湛', '汪', '祁', '毛', '禹', '狄', '米', '贝', '明', '臧', '计', '伏', '成', '戴', '谈', '宋', '茅', '庞', '熊', '纪', '舒', '屈', '项', '祝', '董', '梁', '杜', '阮', '蓝', '闵', '席', '季', '麻', '强', '贾', '路', '娄', '危'
            ];
            var legendData = [];
            var seriesData = [];
            for (var i = 0; i < 50; i++) {
                name = Math.random() > 0.65 ? makeWord(4, 1) + '·' + makeWord(3, 0) : makeWord(2, 1);
                legendData.push(name);
                seriesData.push({
                    name: name,
                    value: Math.round(Math.random() * 100000)
                });
            }

            return {
                legendData: legendData,
                seriesData: seriesData
            };

            function makeWord(max, min) {
                var nameLen = Math.ceil(Math.random() * max + min);
                var name = [];
                for (var i = 0; i < nameLen; i++) {
                    name.push(nameList[Math.round(Math.random() * nameList.length - 1)]);
                }
                return name.join('');
            }
        }
        // dom2 = document.getElementById("pie_min_percent_label")
        //    , instance2 = echarts.getInstanceByDom(dom2);
        //    instance2 = echarts.init(dom2);
        //    instance2.setOption(option2);
        echartsSoap.render("pie_min_percent_label", option2)
            //   if (typeof instance == "undefined") {
            //   instance = echarts.init(dom);
            //   instance.setOption(option);
            // } else {
            //   echarts.dispose(instance);

        //   instance = echarts.init(dom);//echarts "3.3.2" 地图instance.setOption(option, true);后指向地图某个区域左侧Visualmap还是初始时的这个区域的值，这里销毁instance重新init.
        //   instance.setOption(option);
        // }
    </script>
</html>